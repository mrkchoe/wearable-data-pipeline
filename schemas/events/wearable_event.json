{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/events/wearable_event.json",
  "title": "Wearable analytics event",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "schema_version",
    "event_id",
    "event_name",
    "client_ts",
    "server_ts",
    "source",
    "environment",
    "payload"
  ],
  "properties": {
    "schema_version": { "type": "string" },
    "event_id": { "type": "string", "format": "uuid" },
    "event_name": {
      "type": "string",
      "enum": [
        "page_view",
        "identify",
        "connect_device_started",
        "connect_device_succeeded",
        "connect_device_failed",
        "sync_requested",
        "sync_completed",
        "sync_failed",
        "metric_viewed",
        "goal_created",
        "export_clicked",
        "ui_error",
        "api_error",
        "perf_lcp",
        "perf_api_latency"
      ]
    },
    "user_id": { "type": "string" },
    "anonymous_id": { "type": "string" },
    "device_id": { "type": ["string", "null"] },
    "session_id": { "type": "string" },
    "client_ts": { "type": "string", "format": "date-time" },
    "server_ts": { "type": "string", "format": "date-time" },
    "source": { "type": "string", "enum": ["web", "mobile", "api", "sdk"] },
    "environment": { "type": "string", "enum": ["local", "dev", "staging", "prod"] },
    "app_version": { "type": "string" },
    "page": { "type": "string" },
    "referrer": { "type": ["string", "null"] },
    "payload": { "type": "object" }
  },
  "anyOf": [
    { "required": ["user_id"] },
    { "required": ["anonymous_id"] }
  ],
  "allOf": [
    {
      "if": { "properties": { "event_name": { "const": "page_view" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["page_title", "entry_point"],
            "properties": {
              "page_title": { "type": "string" },
              "entry_point": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "identify" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["user_status"],
            "properties": {
              "user_status": { "type": "string", "enum": ["known", "merged", "anonymous"] }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "connect_device_started" } } },
      "then": { "$ref": "#/$defs/vendorPayload" }
    },
    {
      "if": { "properties": { "event_name": { "const": "connect_device_succeeded" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["vendor", "device_model"],
            "properties": {
              "vendor": { "$ref": "#/$defs/vendor" },
              "device_model": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "connect_device_failed" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["vendor", "error_code", "error_message"],
            "properties": {
              "vendor": { "$ref": "#/$defs/vendor" },
              "error_code": { "type": "string" },
              "error_message": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "sync_requested" } } },
      "then": { "$ref": "#/$defs/syncPayload" }
    },
    {
      "if": { "properties": { "event_name": { "const": "sync_completed" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["vendor", "date_range", "sync_status", "records_synced"],
            "properties": {
              "vendor": { "$ref": "#/$defs/vendor" },
              "date_range": { "$ref": "#/$defs/dateRange" },
              "sync_status": { "$ref": "#/$defs/syncStatus" },
              "records_synced": { "type": "integer", "minimum": 0 }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "sync_failed" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["vendor", "date_range", "sync_status", "error_code", "error_message"],
            "properties": {
              "vendor": { "$ref": "#/$defs/vendor" },
              "date_range": { "$ref": "#/$defs/dateRange" },
              "sync_status": { "$ref": "#/$defs/syncStatus" },
              "error_code": { "type": "string" },
              "error_message": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "metric_viewed" } } },
      "then": { "$ref": "#/$defs/metricPayload" }
    },
    {
      "if": { "properties": { "event_name": { "const": "goal_created" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["metric_type", "target_value", "target_unit", "date_range"],
            "properties": {
              "metric_type": { "$ref": "#/$defs/metricType" },
              "target_value": { "type": "number", "minimum": 0 },
              "target_unit": { "type": "string" },
              "date_range": { "$ref": "#/$defs/dateRange" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "export_clicked" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["export_format", "date_range", "vendor"],
            "properties": {
              "export_format": { "type": "string", "enum": ["csv", "json"] },
              "date_range": { "$ref": "#/$defs/dateRange" },
              "vendor": { "$ref": "#/$defs/vendor" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "ui_error" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["component", "error_code", "error_message", "severity"],
            "properties": {
              "component": { "type": "string" },
              "error_code": { "type": "string" },
              "error_message": { "type": "string" },
              "severity": { "type": "string", "enum": ["info", "warning", "error"] }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "api_error" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["endpoint", "status_code", "error_code", "error_message"],
            "properties": {
              "endpoint": { "type": "string" },
              "status_code": { "type": "integer", "minimum": 0 },
              "error_code": { "type": "string" },
              "error_message": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "perf_lcp" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["lcp_ms", "page_type"],
            "properties": {
              "lcp_ms": { "type": "number", "minimum": 0 },
              "page_type": { "type": "string" }
            }
          }
        }
      }
    },
    {
      "if": { "properties": { "event_name": { "const": "perf_api_latency" } } },
      "then": {
        "properties": {
          "payload": {
            "type": "object",
            "additionalProperties": false,
            "required": ["api_latency_ms", "endpoint", "status_code"],
            "properties": {
              "api_latency_ms": { "type": "number", "minimum": 0 },
              "endpoint": { "type": "string" },
              "status_code": { "type": "integer", "minimum": 0 }
            }
          }
        }
      }
    }
  ],
  "$defs": {
    "vendor": {
      "type": "string",
      "enum": ["fitbit", "apple_health", "garmin", "oura", "whoop", "other"]
    },
    "metricType": {
      "type": "string",
      "enum": ["steps", "sleep", "calories", "distance", "active_minutes"]
    },
    "dateRange": {
      "type": "string",
      "enum": ["day", "week", "month", "custom"]
    },
    "syncStatus": {
      "type": "string",
      "enum": ["requested", "in_progress", "completed", "failed"]
    },
    "vendorPayload": {
      "properties": {
        "payload": {
          "type": "object",
          "additionalProperties": false,
          "required": ["vendor"],
          "properties": { "vendor": { "$ref": "#/$defs/vendor" } }
        }
      }
    },
    "metricPayload": {
      "properties": {
        "payload": {
          "type": "object",
          "additionalProperties": false,
          "required": ["metric_type", "date_range", "vendor"],
          "properties": {
            "metric_type": { "$ref": "#/$defs/metricType" },
            "date_range": { "$ref": "#/$defs/dateRange" },
            "vendor": { "$ref": "#/$defs/vendor" }
          }
        }
      }
    },
    "syncPayload": {
      "properties": {
        "payload": {
          "type": "object",
          "additionalProperties": false,
          "required": ["vendor", "date_range", "sync_status"],
          "properties": {
            "vendor": { "$ref": "#/$defs/vendor" },
            "date_range": { "$ref": "#/$defs/dateRange" },
            "sync_status": { "$ref": "#/$defs/syncStatus" }
          }
        }
      }
    }
  }
}
